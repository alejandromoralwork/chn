<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Remembering the Hanzi - Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">üîí Login Required</h2>
            <p class="text-gray-600 mb-4">Enter password to edit the table</p>
            <input type="password" id="passwordInput" placeholder="Enter password"
                   class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="loginBtn" 
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                Login
            </button>
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Incorrect password</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üìö Optimized Remembering the Hanzi</h1>
                    <p class="text-gray-600">Your personal Chinese character study tool</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg hidden">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search characters, meanings, pinyin..."
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="saveAllBtn" disabled
                        class="bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white font-bold py-2 px-6 rounded-lg">
                    üíæ Save All Changes
                </button>
                <button id="refreshBtn"
                        class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-lg">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-blue-600 text-sm font-semibold">Total Characters</p>
                    <p id="totalCount" class="text-2xl font-bold text-blue-700">0</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-green-600 text-sm font-semibold">With Comments</p>
                    <p id="commentedCount" class="text-2xl font-bold text-green-700">0</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4">
                    <p class="text-yellow-600 text-sm font-semibold">Displayed</p>
                    <p id="displayedCount" class="text-2xl font-bold text-yellow-700">0</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <p class="text-purple-600 text-sm font-semibold">Pending Saves</p>
                    <p id="pendingCount" class="text-2xl font-bold text-purple-700">0</p>
                </div>
                <div class="bg-pink-50 rounded-lg p-4">
                    <p class="text-pink-600 text-sm font-semibold">Current Page</p>
                    <p id="pageInfo" class="text-2xl font-bold text-pink-700">1</p>
                </div>
            </div>

            <!-- Pagination Controls -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Rows per page:</label>
                    <select id="rowsPerPage" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="-1">All</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="firstPageBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
                        ‚èÆÔ∏è First
                    </button>
                    <button id="prevPageBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
                        ‚óÄÔ∏è Prev
                    </button>
                    <span class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium" id="pageIndicator">
                        Page 1 of 1
                    </span>
                    <button id="nextPageBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
                        Next ‚ñ∂Ô∏è
                    </button>
                    <button id="lastPageBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
                        Last ‚è≠Ô∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr id="tableHeader">
                            <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID</th>
                            <!-- Dynamic headers will be inserted here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="loadingMsg" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                <p class="mt-4 text-gray-600">Loading data from Firebase...</p>
            </div>
            <div id="noDataMsg" class="hidden text-center py-12">
                <p class="text-gray-600 text-lg">No data found. Please initialize Firebase with your Excel data.</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
        apiKey: "AIzaSyC-kGriQZ02iiVjdbcw0qGIeYGAPQZ5TMw",
        authDomain: "chngit-bb789.firebaseapp.com",
        databaseURL: "https://chngit-bb789-default-rtdb.firebaseio.com",
        projectId: "chngit-bb789",
        storageBucket: "chngit-bb789.firebasestorage.app",
        messagingSenderId: "243263769776",
        appId: "1:243263769776:web:e65cad158619907abaff75",
        measurementId: "G-2R227M02SE"
        };

        // Password - Change this to your desired password
        const PASSWORD = "hanzi";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dataRef = database.ref('hanzi');

        // State
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPageValue = 100;
        let isAuthenticated = false;
        let pendingChanges = new Map();
        let columnKeys = [];

        // Elements
        const loginModal = document.getElementById('loginModal');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const searchInput = document.getElementById('searchInput');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const loadingMsg = document.getElementById('loadingMsg');
        const noDataMsg = document.getElementById('noDataMsg');
        const totalCount = document.getElementById('totalCount');
        const commentedCount = document.getElementById('commentedCount');
        const displayedCount = document.getElementById('displayedCount');
        const pendingCount = document.getElementById('pendingCount');
        const pageInfo = document.getElementById('pageInfo');
        const rowsPerPage = document.getElementById('rowsPerPage');
        const pageIndicator = document.getElementById('pageIndicator');
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        // Login Handler
        loginBtn.addEventListener('click', () => {
            const password = passwordInput.value;
            
            if (password === PASSWORD) {
                isAuthenticated = true;
                loginModal.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                loginError.classList.add('hidden');
                enableEditing();
            } else {
                loginError.classList.remove('hidden');
                passwordInput.value = '';
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        logoutBtn.addEventListener('click', () => {
            isAuthenticated = false;
            loginModal.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            passwordInput.value = '';
            disableEditing();
        });

        // Load Data from Firebase
        function loadData() {
            loadingMsg.classList.remove('hidden');
            noDataMsg.classList.add('hidden');
            tableBody.innerHTML = '';

            dataRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    allData = Array.isArray(data) ? data : Object.values(data);
                    
                    // Get column keys from first item
                    if (allData.length > 0) {
                        columnKeys = Object.keys(allData[0]).filter(key => key !== 'id');
                    }
                    
                    filteredData = [...allData];
                    renderTable();
                    updateStats();
                    loadingMsg.classList.add('hidden');
                } else {
                    loadingMsg.classList.add('hidden');
                    noDataMsg.classList.remove('hidden');
                }
            }).catch((error) => {
                console.error('Error loading data:', error);
                loadingMsg.classList.add('hidden');
                alert('Error loading data from Firebase. Check console for details.');
            });
        }

        // Get Paginated Data
        function getPaginatedData() {
            if (rowsPerPageValue === -1) {
                return filteredData;
            }
            
            const start = (currentPage - 1) * rowsPerPageValue;
            const end = start + rowsPerPageValue;
            return filteredData.slice(start, end);
        }

        // Get Total Pages
        function getTotalPages() {
            if (rowsPerPageValue === -1) return 1;
            return Math.ceil(filteredData.length / rowsPerPageValue);
        }

        // Update Pagination Controls
        function updatePaginationControls() {
            const totalPages = getTotalPages();
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
            pageInfo.textContent = currentPage;
            
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
        }

        // Render Table
        function renderTable() {
            const paginatedData = getPaginatedData();
            
            if (paginatedData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-8 text-gray-500">No matching data</td></tr>';
                updatePaginationControls();
                return;
            }

            // Render headers
            let headerHTML = '<th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID</th>';
            columnKeys.forEach(key => {
                headerHTML += `<th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">${key}</th>`;
            });
            tableHeader.innerHTML = headerHTML;

            // Render rows
            let rowsHTML = '';
            paginatedData.forEach((row, index) => {
                const rowId = row.id || index;
                rowsHTML += `<tr class="hover:bg-gray-50 ${pendingChanges.has(rowId) ? 'bg-yellow-50' : ''}">`;
                rowsHTML += `<td class="px-4 py-3 text-sm font-medium text-gray-900">${rowId}</td>`;
                
                columnKeys.forEach(key => {
                    const value = row[key] || '';
                    const isComments = key.toLowerCase() === 'comments';
                    const cellClass = isComments ? 'text-blue-600' : 'text-gray-900';
                    
                    if (isAuthenticated) {
                        rowsHTML += `<td class="px-4 py-3 text-sm ${cellClass}">
                            <input type="text" 
                                   value="${escapeHtml(value)}" 
                                   data-row-id="${rowId}" 
                                   data-field="${key}"
                                   class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"
                                   />
                        </td>`;
                    } else {
                        rowsHTML += `<td class="px-4 py-3 text-sm ${cellClass}">${escapeHtml(value)}</td>`;
                    }
                });
                
                rowsHTML += '</tr>';
            });
            tableBody.innerHTML = rowsHTML;

            // Add input listeners if authenticated
            if (isAuthenticated) {
                tableBody.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', handleCellEdit);
                });
            }

            updatePaginationControls();
        }

        // Pagination Event Listeners
        rowsPerPage.addEventListener('change', (e) => {
            rowsPerPageValue = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
            updateStats();
        });

        firstPageBtn.addEventListener('click', () => {
            currentPage = 1;
            renderTable();
        });

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < getTotalPages()) {
                currentPage++;
                renderTable();
            }
        });

        lastPageBtn.addEventListener('click', () => {
            currentPage = getTotalPages();
            renderTable();
        });

        // Handle Cell Edit
        function handleCellEdit(e) {
            const rowId = parseInt(e.target.dataset.rowId);
            const field = e.target.dataset.field;
            const newValue = e.target.value;

            // Find the row in allData
            const rowIndex = allData.findIndex(r => r.id === rowId);
            if (rowIndex !== -1) {
                // Track change
                if (!pendingChanges.has(rowId)) {
                    pendingChanges.set(rowId, { ...allData[rowIndex] });
                }
                
                pendingChanges.get(rowId)[field] = newValue;
                saveAllBtn.disabled = false;
                updateStats();
                
                // Highlight changed row
                e.target.closest('tr').classList.add('bg-yellow-50');
            }
        }

        // Save All Changes
        saveAllBtn.addEventListener('click', async () => {
            if (pendingChanges.size === 0) return;

            saveAllBtn.disabled = true;
            saveAllBtn.textContent = 'üíæ Saving...';

            try {
                const updates = {};
                
                for (const [rowId, rowData] of pendingChanges) {
                    const index = allData.findIndex(r => r.id === rowId);
                    if (index !== -1) {
                        updates[index] = rowData;
                        allData[index] = rowData;
                    }
                }

                await dataRef.update(updates);
                
                pendingChanges.clear();
                saveAllBtn.textContent = '‚úÖ Saved!';
                
                setTimeout(() => {
                    saveAllBtn.textContent = 'üíæ Save All Changes';
                    saveAllBtn.disabled = true;
                }, 2000);

                // Remove highlights
                document.querySelectorAll('.bg-yellow-50').forEach(el => {
                    if (!el.classList.contains('bg-yellow-50')) return;
                    el.classList.remove('bg-yellow-50');
                });

                updateStats();
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving changes. Check console for details.');
                saveAllBtn.textContent = 'üíæ Save All Changes';
                saveAllBtn.disabled = false;
            }
        });

        // Search Handler
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (!query) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(row => {
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(query)
                    );
                });
            }
            
            currentPage = 1;
            renderTable();
            updateStats();
        });

        // Refresh Handler
        refreshBtn.addEventListener('click', () => {
            if (pendingChanges.size > 0) {
                if (!confirm('You have unsaved changes. Refreshing will discard them. Continue?')) {
                    return;
                }
            }
            pendingChanges.clear();
            saveAllBtn.disabled = true;
            loadData();
        });

        // Update Stats
        function updateStats() {
            totalCount.textContent = allData.length;
            commentedCount.textContent = allData.filter(r => r.comments && r.comments.trim()).length;
            displayedCount.textContent = filteredData.length;
            pendingCount.textContent = pendingChanges.size;
        }

        // Enable/Disable Editing
        function enableEditing() {
            renderTable();
        }

        function disableEditing() {
            pendingChanges.clear();
            saveAllBtn.disabled = true;
            renderTable();
        }

        // Utility: Escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
